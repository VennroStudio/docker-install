include .env
export

.PHONY: init up down restart logs help

help:
	@echo "üöÄ –ü—Ä–æ–µ–∫—Ç: $(PROJECT_NAME)"
	@echo "========================="
	@echo "  make init              - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  make up                - –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞"  
	@echo "  make down              - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  make logs              - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
	@echo "  make shell-php         - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PHP"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
init: check-infrastructure create-db-if-shared up info

# –ü—Ä–æ–≤–µ—Ä–∫–∞ infrastructure
check-infrastructure:
	@if ! docker network ls | grep -q "traefik-public"; then \
		echo "‚ùå –°–µ—Ç—å traefik-public –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; \
		echo "üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ: make -C ../../infrastructure init"; \
		exit 1; \
	fi

# –°–æ–∑–¥–∞–Ω–∏–µ –ë–î –≤ –æ–±—â–µ–π MariaDB
create-db-if-shared:
ifeq ($(USE_SHARED_DB),true)
	@echo "üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –ë–î $(DB_NAME) –≤ –æ–±—â–µ–π MariaDB..."
	@docker exec infrastructure-mariadb mysql -u root -p$(SHARED_DB_ROOT_PASSWORD) \
		-e "CREATE DATABASE IF NOT EXISTS $(DB_NAME);" \
		-e "CREATE USER IF NOT EXISTS '$(DB_USER)'@'%' IDENTIFIED BY '$(DB_PASSWORD)';" \
		-e "GRANT ALL PRIVILEGES ON $(DB_NAME).* TO '$(DB_USER)'@'%';" \
		-e "FLUSH PRIVILEGES;" 2>/dev/null || echo "‚ö†Ô∏è –ë–î —Å–æ–∑–¥–∞—Å—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ infrastructure"
endif

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
up:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ $(PROJECT_NAME) —Å $(WEB_SERVER)..."
	COMPOSE_PROFILES=$(WEB_SERVER) docker compose up -d

down:
	docker compose down --remove-orphans

restart: down up
logs:
	docker compose logs -f

shell-php:
	docker exec -it $(PROJECT_NAME)-php-fpm bash

info:
	@echo "‚úÖ –ü—Ä–æ–µ–∫—Ç $(PROJECT_NAME) –∑–∞–ø—É—â–µ–Ω!"
	@echo "üåê URL: https://$(PROJECT_DOMAIN)"
	@echo "üåç –í–µ–±-—Å–µ—Ä–≤–µ—Ä: $(WEB_SERVER)"
