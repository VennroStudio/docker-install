include .env
export

.PHONY: help init up down restart logs

# –ü–æ–º–æ—â—å
help:
	@echo "üèóÔ∏è Infrastructure - –æ–±—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤"
	@echo "================================================="
	@echo ""
	@echo "üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make init              - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã"
	@echo "  make up                - –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –æ–±—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
	@echo "  make down              - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
	@echo "  make restart           - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫"
	@echo "  make logs              - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
	@echo ""
	@echo "üîß –ü—Ä–æ—Ñ–∏–ª–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:" 
	@echo "  make up-traefik        - –¢–æ–ª—å–∫–æ Traefik"
	@echo "  make up-shared-db      - Traefik + –æ–±—â–∞—è –ë–î + phpMyAdmin"
	@echo "  make up-full           - –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã (–ë–î, Redis, MailHog)"
	@echo ""
	@echo "üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ URL:"
	@echo "  http://localhost:$(TRAEFIK_DASHBOARD_PORT)  - Traefik Dashboard"
	@echo "  https://pma.shared.local        - phpMyAdmin (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–∞ –æ–±—â–∞—è –ë–î)"
	@echo "  https://mail.local              - MailHog (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
init: clean-networks networks up-traefik up-shared-db info

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ç–µ–π
networks:
	@echo "üåê –°–æ–∑–¥–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö Docker —Å–µ—Ç–µ–π..."
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ç–µ–π..."
	-docker network rm traefik-public 2>/dev/null || true
	-docker network rm shared-services 2>/dev/null || true
	@echo "üî® –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–µ—Ç–µ–π..."
	docker network create traefik-public
	docker network create shared-services
	@echo "‚úÖ –°–µ—Ç–∏ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ"

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–µ—Ç–µ–π
clean-networks:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–µ—Ç–µ–π..."
	-docker network rm traefik-public 2>/dev/null || true
	-docker network rm shared-services 2>/dev/null || true

# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
up: up-traefik
down:
	docker compose -f infrastructure.yml down --remove-orphans

restart: down up
logs:
	docker compose -f infrastructure.yml logs -f

# –ü—Ä–æ—Ñ–∏–ª–∏ –∑–∞–ø—É—Å–∫–∞
up-traefik:
	@echo "üåê –ó–∞–ø—É—Å–∫ Traefik..."
	docker compose -f infrastructure.yml up -d traefik

up-shared-db:
	@echo "üóÑÔ∏è –ó–∞–ø—É—Å–∫ Traefik + –æ–±—â–∞—è –ë–î + phpMyAdmin..."
	COMPOSE_PROFILES=shared-db docker compose -f infrastructure.yml up -d

up-full:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
	COMPOSE_PROFILES=shared-db,shared-cache,mailhog docker compose -f infrastructure.yml up -d

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
info:
	@echo ""
	@echo "‚úÖ Infrastructure –≥–æ—Ç–æ–≤–∞!"
	@echo "======================="
	@echo "üåê Traefik Dashboard: http://localhost:$(TRAEFIK_DASHBOARD_PORT)"
	@echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ç–µ–π:"
	@docker network ls | grep -E "(traefik-public|shared-services)" || echo "   –°–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
	@echo ""
	@echo "üí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
	@echo "   1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç—ã: ../scripts/new-project.sh PROJECT_NAME DOMAIN"
	@echo "   2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ hosts —Ñ–∞–π–ª –¥–ª—è –¥–æ–º–µ–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤"
	@echo "   3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç—ã: make -C ../projects/PROJECT_NAME up"

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç—è–º–∏
list-networks:
	@echo "üåê –°–ø–∏—Å–æ–∫ Docker —Å–µ—Ç–µ–π:"
	@docker network ls | grep -E "(NAME|traefik-public|shared-services|project)"

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
status:
	@echo "üìä –°—Ç–∞—Ç—É—Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:"
	@docker compose -f infrastructure.yml ps
	@echo ""
	@echo "üåê –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ç–∏:"
	@docker network ls | grep -E "(traefik-public|shared-services)"

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞
reinstall: clean-networks down networks up-traefik
	@echo "üîÑ Infrastructure –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
